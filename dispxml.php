<?phprequire_once('inc/_init.php');require_once('inc/functions/general.php');error_reporting(E_ALL | E_STRICT);if($lghsh['Id'] == 0){	require_once('inc/functions/authorization.php'); 	$pgcontent = logform(); 	$page_title       = 'WC Terminal LogIn';	$page_description = '';	$keywords         = '';	$head_ext         = '';	require_once('inc/_shell.php'); ///	exit;	}include_once 'inc/functions.php';include_once 'inc/local/jstat_f.php';setlocale(LC_MONETARY, 'en_US');$msg = NULL;	require_once 'wconfig.php';error_reporting(E_ERROR | E_WARNING | E_PARSE);$oid = NULL;$pcnt = '';////////////////////////////////////////////////////////////////////if(!isset($_GET['oid'])) { die('Missing or invalid order ID'); }$oid = $_GET['oid'];if(isset($_POST['delete_d'])){	mysqli_query($dbh, "DELETE FROM st_jobstat WHERE OID = '$oid'") or die("DB update failed: " . mysqli_error($dbh));	}if(isset($_POST['submitd'])){ 	foreach($_POST as $fk=>$fv){		if(preg_match('/^id_[\d]{1,4}/', $fk)){						$sku_index = preg_replace('/^id_/', 'isku_', $fk);			$qtt_index = preg_replace('/^id_/', 'qtty_', $fk);			$tst_index = preg_replace('/^id_/', 'hstt_', $fk);			$tnd_index = preg_replace('/^id_/', 'hend_', $fk);			$txt_index = preg_replace('/^id_/', 'txtr_', $fk);//$date = new DateTime();//date( 'Y-m-d', $tsSeconds );			// $time_start = date("Y/m/d H:i:s", $_POST[$tst_index]/1000);			// $time_end   = date("Y/m/d H:i:s", $_POST[$tnd_index]/1000);			// $time_diff  = date("Y/m/d H:i:s", ($_POST[$tnd_index]-$_POST[$tst_index]));			$time_start = intval($_POST[$tst_index]);			$time_end   = intval($_POST[$tnd_index]);			$time_diff  = ($time_end>$time_start)?$time_end-$time_start:0;			$note = $_POST[$txt_index];		//		$date2 = new DateTime($_POST[$tnd_index]);			$isku_n     = $_POST[$sku_index];			$isku_qtty  = $_POST[$qtt_index];//			$time_start = $date1->format('Y-m-d H:i:s');//			$time_end   = $date2->format('Y-m-d H:i:s');						//			$date = new DateTime('2000-01-01');//			$pcnt .= $fk.' - '.$fv.' - '.$isku_n.' : '.$isku_qtty.' : '.$time_start.' : '.$time_end.'<br>';		//			if(mysqli_fetch_array(mysqli_query($dbh, "SELECT * FROM st_jobstat WHERE OID='$oid' AND Sku='$fv'"))) { continue; }			if($fv){				$q = "UPDATE st_jobstat SET				TimeStart	= '" . mysqli_escape_string($dbh, $time_start ) . "',				TimeEnd		= '" . mysqli_escape_string($dbh, $time_end ) . "',				TimeDiff	= '" . mysqli_escape_string($dbh, $time_diff ) . "',				User		= '" . mysqli_escape_string($dbh, $lghsh['Id'] ) . "',				Note		= '" . mysqli_escape_string($dbh, $note ) . "'				WHERE id = '$fv'";				mysqli_query($dbh, $q) or die("DB update failed: " . mysqli_error($dbh));				}			else{				$q = "INSERT INTO st_jobstat( OID, Sku, Qtty, TimeStart, TimeEnd, TimeDiff, User, Note	) 					VALUES ( '$oid',					'" . mysqli_escape_string($dbh, $isku_n ) . "',					'" . mysqli_escape_string($dbh, $isku_qtty ) . "',					'" . mysqli_escape_string($dbh, $time_start ) . "',					'" . mysqli_escape_string($dbh, $time_end ) . "',					'" . mysqli_escape_string($dbh, $time_diff ) . "',					'" . mysqli_escape_string($dbh, $lghsh['Id'] ) . "',					'" . mysqli_escape_string($dbh, $note ) . "' )";	//drc($q);				mysqli_query($dbh, $q) or die("DB insert failed: " . mysqli_error($dbh));				}			}		}//if(1) { $pcnt .= 'Job submitted'; }	}//else { //$oid = $_GET['oid']; }//echo date("Y/m/d H:i:s", 1672840053771/1000);$fn = SALES_ORDER_XML;if (!file_exists($fn)) { die("XML file not found"); }	$xml = simplexml_load_file($fn);foreach($xml->QBXMLMsgsRs->SalesOrderQueryRs->SalesOrderRet as $d){	if($d->RefNumber == $oid){		$pcin = '';		$dr = array();		$i=0;		if(chckdb_jstt($oid)){			$q = "SELECT * FROM st_jobstat WHERE OID='$oid'";			$tresult = mysqli_query($dbh, $q) or die (mysqli_error($dbh));			while ($tr = mysqli_fetch_array($tresult)) {				$dr['id']   = $tr['id'];				$dr['sku']  = $tr['Sku'];				$dr['qtty'] = $tr['Qtty'];				$dr['hstt'] = $tr['TimeStart'];				$dr['hend'] = $tr['TimeEnd'];				$dr['tstt'] = ($tr['TimeStart'])?date("Y/m/d H:i:s", $tr['TimeStart']/1000):'Start Time';				$dr['tend'] = ($tr['TimeEnd'])?date("Y/m/d H:i:s", $tr['TimeEnd']/1000):'End Time';				$dr['note'] = $tr['Note'];				$pcin .= fup_t($dr, $i);				}			}		else			{			foreach($d->SalesOrderLineRet as $v){ 				$dr['id']   = NULL;				$dr['sku']  = $v->ItemRef->FullName;				$dr['qtty'] = $v->Quantity;				$dr['hstt'] = NULL;				$dr['hend'] = NULL;				$dr['tstt'] = 'Start Time';				$dr['tend'] = 'End Time';				$pcin .= fup_t($dr, $i);				}			}				$shh = ($lghsh['Prvlg']=='A' OR $lghsh['Prvlg']=='B')?'block':'none';		$pcnt .= '<div>		<script src="files/js/xrsb.js" type="text/javascript"></script>		<form action="" method="post" name="whwstat" style="margin: 0px;"><table class="TBL" cellpadding="0" cellspacing="1"><tr><th colspan="5">	<input type="submit" name="delete_d" value="X" style="float: left; width: 20px; height: 20px; background-color: #f00; display: '.$shh.';" title="Delete Data" OnClick="return deletedata();" />Order - '.$oid.' 	<input type="submit" name="submitd" value="Submit Jobs" style="float: right;" /></th>	<th></th></tr><tr><th>#</th>	<th style="width: 80px;">Start Time</th>	<th style="width: 30px;">Qtty</th>	<th style="width: 200px;">Job</th>	<th style="width: 80px;">End Time</th>	<th></th></tr>'.$pcin.'</table></form>';		}	}//}	$pcnt .= '<div style="clear: both; height: 50px; margin-bottom: 50px; padding: 35px 5px;"><a href="listqbxml.php?xml=so">Order List</a></div></div><div style="clear: both; height: 50px; margin-bottom: 50px;"></div>'; $pgtitle = '<h4>Order Summary</h4>';$pgcontent = <<<EOD__<!-- Page content start -->$pcnt<!-- Page content end -->EOD__;require_once('inc/_shell2.php'); /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////function get_order_items($o){	$str = NULL;foreach($o->SalesOrderLineRet as $ia){	$str .= $ia->ItemRef->FullName . '<br>';	}//	$str = $o->CustomerRef->FullName;		return $str;}function dlcsv(){		$data = array(    array('Jane', 2500),    array('Paul', 2000),    array('Jake', 3000),    array('Tim', 3500),);$filename = 'employees' . '.csv';$delimiter = ',';$f = fopen('php://memory', 'w');$headings = array('name', 'salary');fputcsv($f, $headings, $delimiter);foreach($data as $row) {    fputcsv($f, $row, $delimiter);}fseek($f, 0);//header('Content-Type: text/csv');//header('Content-Disposition: attachment; filename="' . $filename . '";');header('Content-type: text/csv');header('Content-disposition:attachment; filename="'.$filename.'"');readfile($filename);fpassthru($f);fclose($f);exit();	}?>