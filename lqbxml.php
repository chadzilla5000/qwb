<?phpinclude_once('inc/_init.php');include_once('inc/functions/general.php');//error_reporting(E_ALL | E_STRICT);$page_description = '';$keywords         = '';$head_ext         = '';$page_title       = 'Unified WC Terminal';if($lghsh['Id'] == 0){	require_once('inc/functions/authorization.php'); 	$pgcontent = logform(); 	$page_title = 'WC Terminal LogIn';	require_once('inc/_shell.php'); ///	exit;	}include_once 'inc/functions.php';include_once 'wconfig.php';setlocale(LC_MONETARY, 'en_US');ini_set('memory_limit', '2048M');set_time_limit ( 500 );$wcarr = getwcarr();$lt = 0;// foreach($wcarr as $d){		// echo '&nbsp;&nbsp;&nbsp;&nbsp;'. ++$lt. ' - '. $d['id']. ' - '. $d['sku'].'<br>';// }//drc($wcarr);$drln = NULL;if(isset($_POST['changeqbstatus'])){	$Queue = new QuickBooks_WebConnector_Queue($dsn, $qbwc_user); 	if(!empty($_POST['qb_2d_act'])){		foreach($_POST['qb_2d_act'] as $pk=>$pv){			$newid = qbstatchngprep($pv);			if($newid){ $Queue->enqueue(QB_ACT_NONINVENTORYITEM, $newid); }			$drln .= '<div>'.$pv.'</div>';			}		$pcnt = '<div style="margin-top: 25px;"><div style="float: right; padding-right: 25px;"><a href="lqbxml.php">Go to list</a></div>'.$drln.'</div>';		}	}else{$ords = $msg = NULL;$thead = $trows = NULL;$tm = 0;$tr = 0;	$thead = '<tr><th></th>	<th style="font-size: 13px;" colspan="5">QB Product</th>	<th style="font-size: 13px;" colspan="2">Price</th>	<th style="font-size: 13px;" colspan="2">Account Ref.</th>	<th style="font-size: 13px;" colspan="2">Date / Time</th></tr><tr><th style="width: 50px;"><input type="number" style="width: 50px" name="numslct" value="500" max="995" /></th>	<th style="width: 50px;"></th>	<th style="width: 50px; text-align: left;"><input type="checkbox" name="item2sendchkcnt" title="Check/Empty all" value="1" OnChange="chkbxchng(this);" /></th>	<th style="width: 250px;">Sku</th>	<th style="width: 700px;">Title</th>	<th style="width: 150px;"></th>	<th style="width: 70px;"></th>	<th style="width: 70px;">Sale</th>	<th style="width: 130px;"></th>	<th style="width: 130px;"></th>	<th style="width: 130px;"></th>	<th style="width: 130px;">DT modified</th></tr>';/*	$xmlobj = parsenixml(NI_ITEMS_XML);	foreach($xmlobj as $d){ $tm++;//		$tcreat = substr($d->TimeCreated,  0, 19);		if($tm>0 && $tm<=5000){ 				$tmodif = substr($d->TimeModified, 0, 19);			$trname = NULL;			if(	preg_match('/(.*)(-ASM)$/', $d->Name, $m) OR 				preg_match('/(.*)(-RTA)$/', $d->Name, $m) OR 				preg_match('/(.*)(-LEFT)$/', $d->Name, $m) OR 				preg_match('/(.*)(-RIGHT)$/', $d->Name, $m) OR 				preg_match('/(.*)(-SR)$/', $d->Name, $m)){ $trname = preg_replace("/$m[2]/", '', $d->Name); 				}				else{ $trname=$d->Name; }			$gf = array_search($trname, $wcarr); //gIdFromMeta($d->Name);			if($gf){ continue; }				$trows .= '<tr><td>' . ++$tr.' . </td>	<td>'.$tm.'</td>	<td><input type="checkbox" name="qb_2d_act[]" value="'.$d->ListID.'" /></td>	<td>' . $d->Name . '</td>	<td>' . $d->SalesAndPurchase->SalesDesc . '</td>	<td></td>	<td></td>	<td>' . $d->SalesAndPurchase->SalesPrice . '</td>	<td></td>	<td></td>	<td></td>	<td>' . $tmodif . '</td></tr>';			}		}////////////////////////  *///          /* uncomment this line to disable block below  ///////////////////	$result = mysqli_query($dbh, "SELECT * FROM qw_item WHERE ISNULL(Inv) && Active='1' ORDER BY id ASC");	while($rc = mysqli_fetch_assoc($result)){ $tm++;		$trname = NULL;		if(	preg_match('/(.*)(-ASM)$/', 	$rc['Sku'], $m) OR 			preg_match('/(.*)(-RTA)$/', 	$rc['Sku'], $m) OR 			preg_match('/(.*)(-LEFT)$/', 	$rc['Sku'], $m) OR 			preg_match('/(.*)(-RIGHT)$/', 	$rc['Sku'], $m) OR 			preg_match('/(.*)(-SR)$/', 		$rc['Sku'], $m)){ $trname = preg_replace("/$m[2]/", '', $rc['Sku']); 			}			else{ $trname=$rc['Sku']; }		$gf = array_search($trname, $wcarr); //gIdFromMeta($d->Name);		if($gf){ continue; }			$trows .= '<tr><td>' . ++$tr.' . </td>	<td>'.$tm.'</td>	<td><input type="checkbox" name="qb_2d_act[]" value="'.$rc['QBListID'].'" /></td>	<td>' . $rc['Sku'] . '</td>	<td>' . $rc['Title'] . '</td>	<td></td>	<td></td>	<td>' . $rc['SPrice'] . '</td>	<td></td>	<td></td>	<td></td>	<td>' . $rc['DTModified'] . '</td></tr>';		}//////////////////////  Till here  */$pcnt = '<form method="post" action="lqbxml.php" name="DActForm"><div style="margin-top: 25px;"><!-- div style="float: left;">&nbsp; &nbsp;<input type="button" name="xmlreq" value="Request XML" style="padding: 1px 5px;" OnClick="return requestqbinventoryxml();" /> &nbsp; &nbsp;</div><div style="float: right;">&nbsp; &nbsp;<input type="Submit" name="updb" value="Update DB" style="padding: 1px 5px;" /> &nbsp; &nbsp;</div --><div style="clear: both;"><input type="submit" name="changeqbstatus" value="Deactivate" /></div></div><table class="TBL" width="100%" cellspacing="1">'.$thead.''.$trows.'</table></form><script>function chkbxchng(o){	var items = document.getElementsByName("qb_2d_act[]");	var b2 = DActForm.numslct.value;	if(o.checked) {        for (var i = 0; i < items.length; i++) {			if(b2>0 && i>=b2){ return; } 			if (items[i].type == "checkbox" && items[i].disabled == false) { items[i].checked = true; }			}		}	else { 		for (var i = 0; i < items.length; i++) {			if(b2>0 && i>=b2){ return; } 			if (items[i].type == "checkbox" && items[i].disabled == false) { items[i].checked = false; }			}		}return;}</script>';}$pgtitle = '<h4>List</h4>';$pgcontent = <<<EOD__<!-- Page content start -->$pcnt<!-- Page content end -->EOD__;require_once('inc/_shell.php'); //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////// FP ///////////////////////////function gIdFromMeta( $meta_value ) {    global $wpdb;	// $row = mysqli_fetch_row(mysqli_query($wcn, "SELECT post_id FROM wp_postmeta WHERE meta_key = '_sku' AND meta_value = '$meta_value'", MYSQLI_ASSOC));	// return ($row[0])?$row[0]:NULL;    $pid = $wpdb->get_var( $wpdb->prepare("SELECT post_id FROM $wpdb->postmeta WHERE meta_value = '$meta_value' AND meta_key = '_sku' ORDER BY post_id DESC") );    // if( $pid != '' )        // return $pid;    // else 	return $pid;}function getwcarr(){//$brand = NULL;$inc=0;	$itarr = array();$args = array(	'post_type'             => 'product',	'post_status'           => 'publish',	'fields' => 'ids',	'fields' => 'sku',	'ignore_sticky_posts'   => 1,	'offset' 				=> 0,	'posts_per_page'        => -1	);//$items = get_posts_fields( $args ); $items = get_posts( $args ); foreach($items as $ii){	$itarr[$ii->ID] = $ii->_sku;//	$itarr[$inc]['id']     = $ii->ID;//	$itarr[$inc]['sku']    = $ii->_sku;	// $itarr[$inc]['slug']   = $ii->post_name;	// $itarr[$inc]['title']  = $ii->post_title;	// $itarr[$inc]['rprice'] = $ii->_regular_price;	// $itarr[$inc]['price']  = $ii->_price;//	$itarr[$inc]['type']   = ( $prod->is_type('variable') )?'variable':'simple'; // $ii->get_type();//	$itarr[$inc]['type']   = $ii->post_type;	$inc++;// }			}return $itarr;}function qbstatchngprep($v, $act=0){ global $dbh;	$qp = mysqli_query($dbh, "SELECT * FROM qw_item WHERE QBListID='$v'") or die('Error: ' . mysqli_error($dbh));	$ir = mysqli_fetch_assoc($qp);	$que = "INSERT INTO wc_item ( QBListID, EdSeq, Active, IncAccRef, ExpAccRef ) 		VALUES (			'" . mysqli_escape_string($dbh, $ir['QBListID'] ) . "',			'" . mysqli_escape_string($dbh, $ir['EdSeq'] ) . "',			'" . mysqli_escape_string($dbh, $act ) . "',			'" . mysqli_escape_string($dbh, $ir['IncAccRef'] ) . "',			'" . mysqli_escape_string($dbh, $ir['ExpAccRef'] ) . "'			)";	mysqli_query($dbh, $que) or die('Error: ' . mysqli_error($dbh));	return mysqli_insert_id($dbh);}function parsenixml($fn){	if (!file_exists($fn)) { die("XML file not found"); }	$xml = simplexml_load_file($fn);	return $xml->QBXMLMsgsRs->ItemNonInventoryQueryRs->ItemNonInventoryRet;}?>