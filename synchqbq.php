<?phpinclude_once('inc/_init.php');include_once('inc/functions/general.php');error_reporting(E_ALL | E_STRICT);$page_description = '';$keywords         = '';$head_ext         = '';$page_title       = 'Unified WC Terminal';if($lghsh['Id'] == 0){	require_once('inc/functions/authorization.php'); 	$pgcontent = logform(); 	$page_title = 'WC Terminal LogIn';	require_once('inc/_shell.php'); ///	exit;	}include_once 'inc/functions.php';setlocale(LC_MONETARY, 'en_US');$ords = $msg = NULL;include_once 'wconfig.php';//echo $_SERVER['DOCUMENT_ROOT'];$tinf  = NULL;$trows = '';$updb  = 0;$upd_ed = $ins_ed = 0;///////////////////////////////////////////////      Items update    //////////////////////////////////////////////////////////if(isset($_POST['updb_nitem'])){  ////////////     NI Items update  //////////////////////////////////////////////////////////	$fn = NI_ITEMS_XML;	if (!file_exists($fn)) { die("XML file not found"); } ////////// Exit if no XML found ///	if (filesize($fn)<44844290) { die("XML file seems corrupted"); } ////////// Exit if XML damage /////	mysqli_query($dbh, "TRUNCATE TABLE qw_item"); 	mysqli_query($dbh, "DELETE FROM qw_item WHERE ISNULL(Inv)"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->ItemNonInventoryQueryRs->ItemNonInventoryRet as $d){		$tcreat = substr($d->TimeCreated,  0, 19);		$tmodif = substr($d->TimeModified, 0, 19);		$isact  = ($d->IsActive=='true') ? 1 : 0 ; 		$title  = preg_replace('/\W/', ' ', $d->SalesAndPurchase->SalesDesc);//		$vendor = $d->PrefVendorRef->FullName;		$pcost  = ($d->SalesAndPurchase->PurchaseCost) ? $d->SalesAndPurchase->PurchaseCost : 0;		$scost  = ($d->SalesAndPurchase->SalesPrice) ? $d->SalesAndPurchase->SalesPrice : 0;		$que = "INSERT INTO	qw_item	( QBListID, EdSeq, Inv, Active, Sku, Title, Vendor, VCost, SPrice, IncAccRef, ExpAccRef, DTCreated, DTModified			) VALUES (				'" . mysqli_escape_string($dbh, $d->ListID ) . "',				'" . mysqli_escape_string($dbh, $d->EditSequence ) . "',				NULL,				'" . $isact . "',				'" . mysqli_escape_string($dbh, $d->Name ) . "',				'" . mysqli_escape_string($dbh, $title ) . "',				'" . mysqli_escape_string($dbh, $d->PrefVendorRef->FullName ) . "',				'" . mysqli_escape_string($dbh, $pcost ) . "',				'" . mysqli_escape_string($dbh, $scost ) . "',				'" . (($d->SalesAndPurchase->IncomeAccountRef)?$d->SalesAndPurchase->IncomeAccountRef->FullName:NULL) . "',				'" . (($d->SalesAndPurchase->ExpenseAccountRef)?$d->SalesAndPurchase->ExpenseAccountRef->FullName:NULL) . "',				'" . mysqli_escape_string($dbh, $tcreat ) . "',				'" . mysqli_escape_string($dbh, $tmodif ) . "'				)";//drc($que);		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		$ins_ed++;		upd_consolisku($d->Name);   ////////////////     Need to make		}	$tinf = ($ins_ed)? "Created: $ins_ed items;":"";	}//////////////////////////////////////////////////////////if(isset($_POST['updb_iitem'])){   ////////////       NI Items update   ////////////////////////////////////////////////////////////	$fn = "data/sinchro/noninvitems_basic.xml";//	$fn = preg_replace('/\/qbw\//','',NI_ITEMS_XML);	$fn = I_ITEMS_XML;	if (!file_exists($fn)) { die("XML file not found"); } ////////// Exit if no XML found /////	if (filesize($fn)<44844290) { die("XML file seems corrupted"); } ////////// Exit if XML damage ///	mysqli_query($dbh, "DELETE FROM qw_item WHERE Inv='1'"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->ItemInventoryQueryRs->ItemInventoryRet as $d){//		$ith = getblhshbysku('qw_item', $d->Name);//		if($ith){ continue; }		$tcreat = substr($d->TimeCreated,  0, 19);		$tmodif = substr($d->TimeModified, 0, 19);		$isact  = ($d->IsActive=='true') ? 1 : 0 ; 			$que = "INSERT INTO	qw_item	( QBListID, EdSeq, Inv, Active, Sku, Title, Vendor, VCost, SPrice, IncAccRef, ExpAccRef, DTCreated, DTModified			) VALUES (				'" . mysqli_escape_string($dbh, $d->ListID ) . "',				'" . mysqli_escape_string($dbh, $d->EditSequence ) . "',				'1',				'" . $isact . "',				'" . mysqli_escape_string($dbh, $d->Name ) . "',				'" . mysqli_escape_string($dbh, $d->SalesDesc ) . "',				'" . mysqli_escape_string($dbh, $d->PrefVendorRef->FullName ) . "',				'" . mysqli_escape_string($dbh, $d->PurchaseCost ) . "',				'" . mysqli_escape_string($dbh, $d->SalesPrice ) . "',				'" . (($d->IncomeAccountRef)?$d->IncomeAccountRef->FullName:NULL) . "',				'" . (($d->COGSAccountRef)?$d->COGSAccountRef->FullName:NULL) . "',				'" . mysqli_escape_string($dbh, $tcreat ) . "',				'" . mysqli_escape_string($dbh, $tmodif ) . "'				)";//drc($que);		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		$ins_ed++;		upd_consolisku($d->Name);   ////////////////     Need to make		}	$tinf = ($ins_ed)? "Created: $ins_ed items;":"";	}/*if(isset($_POST['updb_item1w'])){   ////////////        Items update   //////////////////////////////////////////////////////////	$fn = NI_ITEMS_XML;	if (!file_exists($fn)) { die("XML file not found"); }	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->ItemNonInventoryQueryRs->ItemNonInventoryRet as $d){		$tcreat = substr($d->TimeCreated,  0, 19);		$tmodif = substr($d->TimeModified, 0, 19);		$que = "INSERT INTO	qw_item	( QBListID, EdSeq, Sku, Title, VCost, SPrice, IncAccRef, ExpAccRef, DTCreated, DTModified		) VALUES (			'" . mysqli_escape_string($dbh, $d->ListID ) . "',			'" . mysqli_escape_string($dbh, $d->EditSequence ) . "',			'" . mysqli_escape_string($dbh, $d->Name ) . "',			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->SalesDesc ) . "',			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->PurchaseCost ) . "',			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->SalesPrice ) . "',			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->IncomeAccountRef->FullName ) . "',			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->ExpenseAccountRef->FullName ) . "',			'" . mysqli_escape_string($dbh, $tcreat ) . "',			'" . mysqli_escape_string($dbh, $tmodif ) . "'			)";//		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		//		upd_consolisku($d->Name);   ////////////////     Need to make		}	}//			'" . mysqli_escape_string($dbh, $d->SalesAndPurchase->PrefVendorRef->FullName ) . "',*/if(isset($_POST['updb_customer'])){   ////////////  Customers update   //////////////////////////////////////////////////////////	$fn = QB_CUSTOMER_XML;	if (!file_exists($fn)) { die("XML file not found"); }	mysqli_query($dbh, "TRUNCATE TABLE qw_customer"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->CustomerQueryRs->CustomerRet as $d){		$tcreat = substr($d->TimeCreated,  0, 19);		$tmodif = substr($d->TimeModified, 0, 19);//		$nm = preg_replace('/\W/','',$d->FullName);		$name  = preg_replace('/\'/','',$d->FullName);		$name  = preg_replace('/\"/','',$name);		$fname = preg_replace('/\W/','',$d->FirstName);		$lname = preg_replace('/\W/','',$d->LastName);		$phone = trtphonum($d->Phone);				$que = "INSERT INTO	qw_customer	( name, fname, lname, phone, email, quickbooks_listid, quickbooks_editsequence		) VALUES (			'" . mysqli_escape_string($dbh, $name ) . "',			'" . mysqli_escape_string($dbh, $fname ) . "',			'" . mysqli_escape_string($dbh, $lname ) . "',			'" . mysqli_escape_string($dbh, $phone ) . "',			'" . mysqli_escape_string($dbh, $d->Email ) . "',			'" . mysqli_escape_string($dbh, $d->ListID ) . "',			'" . mysqli_escape_string($dbh, $d->EditSequence ) . "'			)";		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		$ins_ed++;		}	$tinf = ($ins_ed)? "Created: $ins_ed customers;":"";	}if(isset($_POST['updb_estimate'])){	$fn = QBESTIMATE_XML;	if (!file_exists($fn)) { die("XML file not found"); }	mysqli_query($dbh, "DELETE FROM qw_xt WHERE oname='Estimate'"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->EstimateQueryRs->EstimateRet as $d){				$que = "INSERT INTO	qw_xt	( oname, IID, QBListID		) VALUES (			'Estimate',			'" . mysqli_escape_string($dbh, $d->RefNumber ) . "',			'" . mysqli_escape_string($dbh, $d->CustomerRef->ListID ) . "'			)";		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		}	}if(isset($_POST['updb_order'])){	$fn = SALES_ORDER_XML;	if (!file_exists($fn)) { die("XML file not found"); }	mysqli_query($dbh, "DELETE FROM qw_xt WHERE oname='Order'"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->SalesOrderQueryRs->SalesOrderRet as $d){				$que = "INSERT INTO	qw_xt	( oname, IID, QBListID		) VALUES (			'Order',			'" . mysqli_escape_string($dbh, $d->RefNumber ) . "',			'" . mysqli_escape_string($dbh, $d->CustomerRef->ListID ) . "'			)";		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		}	}if(isset($_POST['updb_payment'])){	$fn = QBPAYMENT_XML;	if (!file_exists($fn)) { die("XML file not found"); }	mysqli_query($dbh, "DELETE FROM qw_xt WHERE oname='Order'"); 	$xml = simplexml_load_file($fn);	foreach($xml->QBXMLMsgsRs->ReceivePaymentQueryRs->ReceivePaymentRet as $d){				$que = "INSERT INTO	qw_xt	( oname, IID, QBListID		) VALUES (			'Payment',			'" . mysqli_escape_string($dbh, $d->RefNumber ) . "',			'" . mysqli_escape_string($dbh, $d->CustomerRef->ListID ) . "'			)";		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		}	}/*if(0){	if ($dbh){ 		mysqli_query($dbh, "TRUNCATE TABLE qw_customer");		$updb = 1;		}	else{ die("Connection failed: " . mysqli_connect_error()); }	}$xml = simplexml_load_file("data/sinchro/qbcustomers.xml");$tm = 0;foreach($xml->QBXMLMsgsRs->CustomerQueryRs->CustomerRet as $d){ $tm++;	$tcreat = substr($d->TimeCreated,  0, 19);	$tmodif = substr($d->TimeModified, 0, 19);	if($updb){				$nm = preg_replace('/\W/','',$d->FullName);		$fn = preg_replace('/\W/','',$d->FirstName);		$ln = preg_replace('/\W/','',$d->LastName);		$ph = trtphonum($d->Phone);				$que = "INSERT INTO	qw_customer	( name, fname, lname, phone, email, quickbooks_listid, quickbooks_editsequence		) VALUES (			'" . mysqli_escape_string($dbh, $nm ) . "',			'" . mysqli_escape_string($dbh, $fn ) . "',			'" . mysqli_escape_string($dbh, $ln ) . "',			'" . mysqli_escape_string($dbh, $ph ) . "',			'" . mysqli_escape_string($dbh, $d->Email ) . "',			'" . mysqli_escape_string($dbh, $d->ListID ) . "',			'" . mysqli_escape_string($dbh, $d->EditSequence ) . "'			)";		mysqli_query($dbh, $que) or die("DB update failed: " . mysqli_connect_error());		}	}*///$cd = time();//$dt = date("Y-m-d", strtotime($cd));//$dt = date("Y-m-d", strtotime("-1 week"));$pcnt = '<style>#VT4 {	width: 100%; margin-top: 25px;}#VT4 td{	padding: 20px;}.VTD{	font-size: 21px;	font-weight: bold;	border-radius: 15px;}</style><div style="float: right; margin-right: 50px; background: #ffd;">'.$tinf.'</div><form method="post" action="synchqbq.php" name="VMForm"><table id="VT4"><tr><td><input type="button" name="xmlreq_iitem" value="Request items XML" style="padding: 1px 5px;" OnClick="return request_xml(\'iitem\');" /></td>	<td class="VTD" id="cnt_iitem">Inventory Item synchronization</td>	<td style="width: 180px;" nowrap><a href="listqbxml.php?xml=iitem">View XML</a></td>	<td><input type="Submit" name="updb_iitem" value="Update item DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_nitem" value="Request items XML" style="padding: 1px 5px;" OnClick="return request_xml(\'nitem\');" /></td>	<td class="VTD" id="cnt_nitem">Non Inventory Item synchronization</td>	<td style="width: 180px;" nowrap><a href="listqbxml.php?xml=nitem">View XML</a></td>	<td><input type="Submit" name="updb_nitem" value="Update item DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_customer" value="Request customers XML" style="padding: 1px 5px;" OnClick="return request_xml(\'customer\');" /></td>	<td class="VTD" id="cnt_customer" style="width: 80%;">Customers synchronization</td>	<td><a href="listqbxml.php?xml=cst">View XML</a></td>	<td><input type="Submit" name="updb_customer" value="Update customer DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_estimate" value="Request estimates XML" style="padding: 1px 5px;" OnClick="return request_xml(\'estimate\');" /></td>	<td class="VTD" id="cnt_estimate">Estimate synchronization</td>	<td></td>	<td><input type="Submit" name="updb_estimate" value="Update estimate DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_order" value="Request SO XML" style="padding: 1px 5px;" OnClick="return request_xml(\'order\');" /></td>	<td class="VTD" id="cnt_order">Sales order synchronization</td>	<td><a href="listqbxml.php?xml=so">View XML</a></td>	<td><input type="Submit" name="updb_order" value="Update order DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_payment" value="Request payments XML" style="padding: 1px 5px;" OnClick="return request_xml(\'payment\');" /></td>	<td class="VTD" id="cnt_payment">Payment synchronization</td>	<td></td>	<td><input type="Submit" name="updb_payment" value="Update payment DB" style="padding: 1px 5px;" /></td></tr><tr><td><input type="button" name="xmlreq_porder" value="Request PO XML" style="padding: 1px 5px;" OnClick="return request_xml(\'porder\');" /></td>	<td class="VTD" id="cnt_porder">Purchase order synchronization</td>	<td></td></tr></table></form><script>function request_xml(qi){	var url = "qbquery.php?qi="+qi;	var prt = perform(url); 	if( prt ){ alert(prt); }			var dv = document.getElementById("cnt_"+qi);	dv.style.backgroundColor = "#f00";	dv.innerHTML = "Run QB Web Connector to generate XML";	dv.style.color = "#fff";			return false;	}function xml_uptable(q){	var url = "synchqbq.php?qup="+q;	var prt = perform(url); 	if(prt){alert(prt);}	return false;	}</script>';$page_title = 'QB synchronization';$hsct = 'qbsnch';$pgcontent = <<<EOD__<!-- Page content start -->$pcnt<!-- Page content end -->EOD__;require_once('inc/_shell.php'); /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////function checkxst($sku){ global $dbh;	$q = "SELECT id FROM qw_item_tst WHERE Sku='$sku'";	$result = mysqli_query($dbh, $q);	if($result->num_rows){ return 1; }	return 0;	}	?>