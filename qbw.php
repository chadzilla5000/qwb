<?phprequire_once('inc/_init.php');require_once('inc/functions/general.php');require_once('inc/functions/qbw_fs.php');require_once('inc/functions/paypal.php');require_once('inc/functions/authnet.php');//error_reporting(E_ALL | E_STRICT);//error_reporting(E_ALL ^ E_NOTICE);$page_description = '';$keywords         = '';$head_ext         = '<script src="files/js/Base.js" type="text/javascript"></script>';$page_title       = 'Unified WC Terminal';if($lghsh['Id'] == 0){	require_once('inc/functions/authorization.php'); 	$pgcontent = logform(); 	$page_title = 'WC Terminal LogIn';	require_once('inc/_shell.php'); ///	exit;	}$dsbl_0 = $dsbl_1 = $dsbl_2 = $dsbl_3 = 'disabled';if($lghsh['Prvlg']=='A' OR $lghsh['Prvlg']=='B') { $dsbl_0 = ''; }include_once 'inc/functions.php';setlocale(LC_MONETARY, 'en_US');$cst = NULL;$ords = $msg = NULL;require_once 'wconfig.php';error_reporting(E_ERROR | E_WARNING | E_PARSE);//////////// Form handler ////////////////////////////////////////////////////if(isset($_POST['fsbm'])){ $Queue = new QuickBooks_WebConnector_Queue($dsn, $qbwc_user); 	if($_POST['customer2send']){ ////////////////////////////////////////   Preparing customer(s) to send ///////////////////////////////		foreach($_POST['customer2send'] as $sv){			$newid = insertCustomer($sv);			$Queue->enqueue(QUICKBOOKS_ADD_CUSTOMER, $newid);			}		$msg .= 'Customer(s) checked';		}		if($_POST['order2send']){ ///////////////////////////////////////////   Preparing order(s) to send //////////////////////////////////		foreach($_POST['order2send'] as $sv){			$newid = insertOrder($sv, $Queue);			if($_POST['ordest_'.$sv]=='Est') { $Queue->enqueue(QUICKBOOKS_ADD_ESTIMATE, $newid); }			else							 { $Queue->enqueue(QUICKBOOKS_ADD_SALESORDER, $newid); }			$ords .= '<em title="'.$newid.'">'.$sv.'</em>';				}		$msg .= 'Order(s) '.$ords.' checked';		}	if(isset($_POST['manualsendorder'])){ ///////////////////////////////////////////   Preparing order to send manually //////////////////////////////////		$onm = $_POST['singlorder'];		$clid = (isset($_POST['manualcustomerselect']))?$_POST['manualcustomerselect']:NULL;				$newid = insertOrderManual($onm, $clid);		if($_POST['ordest_'.$sv]=='Est') { $Queue->enqueue(QUICKBOOKS_ADD_ESTIMATE, $newid); }		else							 { $Queue->enqueue(QUICKBOOKS_ADD_SALESORDER, $newid); }		$msg .= 'Order '.$onm.' prepared to send manually to '.$clid;		}		if($_POST['payment2send']){ /////////////////////////////////////////   Preparing payment(s) to send ////////////////////////////////		foreach($_POST['payment2send'] as $sv){			$newid = insertPayment($sv);			if($newid){ $Queue->enqueue(QUICKBOOKS_ADD_PAYMENTITEM, $newid); }			else{ $msg .= $sv.' <span style="color: #f00;">Query failed</span> '; }			}		$msg .= 'Payment(s) checked';		}	if(isset($_POST['singlepmt_au'])){ /////////////////////////////////////////   Preparing Auth.net payment(s) to send ////////////////////////////////			$newid = insinglePayment_au($_POST['singlepmt_au']);			if($newid){ $Queue->enqueue(QUICKBOOKS_ADD_PAYMENTITEM, $newid); }			else{ $msg .= $_POST['singlepmt_au'].' <span style="color: #f00;">Query failed</span> '; }		$msg .= 'Payment(s) checked';		}	if(isset($_POST['singlepmt_pp'])){ /////////////////////////////////////////   Preparing PayPal payment(s) to send ////////////////////////////////			$newid = insinglePayment_pp($_POST['singlepmt_pp']);			if($newid){ $Queue->enqueue(QUICKBOOKS_ADD_PAYMENTITEM, $newid); }			else{ $msg .= $_POST['singlepmt_pp'].' <span style="color: #f00;">Query failed</span> '; }		$msg .= 'Payment(s) checked';		}	$msg .=($msg)?'':'No data to send to QB';      ////////////////////////////////// ////////////////////////////////////  /////////////	}$sword = (isset($_POST['SWord']))?strtolower($_POST['SWord']):NULL;////////////////////////////////////////////////////////////////////$lmt = (isset($_POST['rowsonpage']))?$_POST['rowsonpage']:50;$trows = '';$t = 0; $vt = 0;$args = array(    'limit' => $lmt,    'orderby' => 'date',    'order'   => 'DESC',    'return'  => 'ids');$query = new WC_Order_Query( $args );$orders = $query->get_orders();foreach($orders as $oid){	$ord_sent = $pay_sent = 0;	$od = new WC_Order($oid);	$om = get_post_meta($oid);$com4sr = strtolower($om['_billing_company'][0]);$ln4sr = strtolower($om['_billing_last_name'][0]);$fn4sr = strtolower($om['_billing_first_name'][0]);$em4sr = strtolower($om['_billing_email'][0]);$ph4sr = strtolower($om['_billing_phone'][0]);if(strlen($sword)>2 AND!preg_match("/$sword/", $oid) AND!preg_match("/$sword/", $com4sr) AND!preg_match("/$sword/", $ln4sr) AND!preg_match("/$sword/", $fn4sr) AND!preg_match("/$sword/", $em4sr) AND!preg_match("/$sword/", $ph4sr)){ continue; }	$bgclose = 'transparent';$tclschecked = '';if(chkordcls($oid)){ //echo chkordcls($oid). '<br>';	$bgclose     = '#090';	$tclschecked = 'checked';	}// if($oid==319701){// updordcls($oid, 1);// }	$trows .= '<tr id="dtr_'.$oid.'" style="background: '.$bgclose.';"><td>'.++$t.'. </td><td style="width: 50px;"><a href="dispcns.php?sbj=order&oid='.$oid.'" OnClick="return load_console(this.href, \'80%\', \'80%\');">'.$oid.'</a></td>';//$cml = $om['_billing_email'][0];//$cph = $om['_billing_phone'][0];$phonum = trtphonum($om['_billing_phone'][0], false);$phstyle='#000';if(!$phonum){ $phstyle='#f00';	$phonum = $om['_billing_phone'][0];	}	$cust_sent = chkcustomer($om);	$dsbl_custchbx  = $dsbl_ordchbx = $dsbl_paychbx = $dsbl_ordest = 'disabled';	$chk_custchbx  = $chk_ordchbx  = $chk_paychbx  = '';	$clr_custchbx = $clr_ordchbx  = $clr_paychbx  = 'transparent';if($om['_billing_email'][0]){	if($cust_sent=='NA' AND !$tclschecked){$chk_custchbx = 'checked'; $clr_custchbx = '#fc9'; $dsbl_custchbx = ''; }elseif($cust_sent==NULL AND !$tclschecked){ $dsbl_custchbx = ''; }else					{ $chk_custchbx = 'checked'; $clr_custchbx = '#0cf'; }}	if($ord_sent){	$chk_ordchbx = 'checked'; $clr_ordchbx = '#9c9'; }	else{		$chk_ordchbx = ''; $clr_ordchbx = '#fc9'; 		if($om['_billing_email'][0] AND $cust_sent AND !$tclschecked){ 			$dsbl_ordchbx = ''; 			}		}	if($pay_sent){			$chk_paychbx = 'checked'; 		$clr_paychbx = '#9c9'; 		}	else{		$chk_paychbx = ''; 		$clr_paychbx = '#fc9'; //		if($om['_billing_email'][0] AND $cust_sent){ $dsbl_paychbx = ''; }//		if(1){ $dsbl_paychbx = ''; }		}		$shipdiff = (		($om['_shipping_first_name'][0] != '' AND $om['_shipping_first_name'][0] != $om['_billing_first_name'][0]) OR		($om['_shipping_last_name'][0]  != '' AND $om['_shipping_last_name'][0]  != $om['_billing_last_name'][0])  OR		($om['_shipping_address_1'][0]  != '' AND $om['_shipping_address_1'][0]  != $om['_billing_address_1'][0])  OR		($om['_shipping_city'][0]       != '' AND $om['_shipping_city'][0]       != $om['_billing_city'][0])       OR		($om['_shipping_state'][0]      != '' AND $om['_shipping_state'][0]      != $om['_billing_state'][0])      OR		($om['_shipping_postcode'][0]   != '' AND $om['_shipping_postcode'][0]   != $om['_billing_postcode'][0])) ?		 $om['_shipping_first_name'][0] . ' ' . 		 $om['_shipping_last_name'][0]  . ' ' . 		 $om['_shipping_address_1'][0]  . ' ' . 		 $om['_shipping_city'][0]       . ' ' . 		 $om['_shipping_state'][0]      . ' ' . 		 $om['_shipping_postcode'][0]   : '<label style="color: #999;">Same as billing</lable>';	if( !$om['_billing_email'][0] ) { $shipdiff = ''; }$dsbl_ordest = '';//echo '<pre>'; print_r($om); echo '</pre><br><br><br>';$pmt = NULL;switch($om['_payment_method'][0])	{	case 'authnet':if($cust_sent AND $om['Authorize.Net Payment ID'][0] AND !$tclschecked){ $dsbl_paychbx = ''; }		$pmt = '<a title="Authorize.net transaction details" href="tx_au.php?oid='.$oid.'&pm=authnet&trid='.$om['Authorize.Net Payment ID'][0].'" 			OnClick="return load_console(this.href, \'70%\', \'90%\');">' . $om['_paid_date'][0] . '</a>';	break;	case 'paypal':if($cust_sent AND $om['_transaction_id'][0] AND !$tclschecked){ $dsbl_paychbx = ''; }		$pmt = '<a title="Paypal transaction details" href="tx_pp.php?oid='.$oid.'&pm=paypal&trid='.$om['_transaction_id'][0].'" 			OnClick="return load_console(this.href, \'70%\', \'90%\');">' . $om['_paid_date'][0] . '</a>';	break;	default:		$pmt = '<span style="color: #c99;">'.$om['_paid_date'][0].'</span>';	break;	}$oesclr = $pmtclr = NULL;$clr_paychbx='transparent';$clr_ordchbx=(chk_seop('Order', $oid))?'#0cf':((chk_seop('Estimate', $oid))?'#fc0':'transparent');if($om['_transaction_id'][0]){ $clr_paychbx=(chk_seop('Payment', $om['_transaction_id'][0]))?'#0cf':'transparent'; }//($om['Authorize.Net Payment ID'][0])?'<a title="View payment details" href="trnx.php?trid='.$om['Authorize.Net Payment ID'][0].'" OnClick="return load_console(this.href, \'70%\', \'90%\');">'.$om['_paid_date'][0].'</a>':'';$styleadd=($od->customer_note)?'border-right: double 3px #f00; border-left: double 3px #f00; cursor: pointer;':'';$jspp = ($od->customer_note)?'OnMouseOver="pupnote(this);" OnMouseOut="pclsnote(this);"':'';$chtbx = '<input type="checkbox" name="payment2send[]" id="p2s_'.$oid.'" title="Send payment to QB" value="'.$oid.'" '.$dsbl_paychbx.' '.$chk_paychbx.' />';//'<input type="text" name="payment2sendtxb[]" placeholder="Choose" style="width: 70px;" id="ptxbx_'.$oid.'" value="" '.$dsbl_paychbx.' OnKeyUp="slcustomer(this);" />';	$trows .= '<td style="width: 20px; text-align: center;"><input type="checkbox" name="order2send[]" id="o2s_'.$oid.'" title="Send order to QB" value="'.$oid.'" '.$dsbl_ordchbx.' '.$chk_ordchbx.' /></td><td style="width: 80px; text-align: center;"><select name="ordest_'.$oid.'" style="font-size: 12px;" title="Send to QB as" '.$dsbl_ordest.'>	<option value="Est">Estimate</option>	<option value="Ord" selected>Order</option></select></td><td style="width: 130px; text-align: center; background-color: '.$clr_ordchbx.'; '.$styleadd.'" '.$jspp.' id="cnotd_'.$oid.'">'.$od->order_date.'<div style="display: none; position: absolute; background: #ff0; padding: 5px; max-width: 350px; border: solid 1px #999; border-radius: 5px; z-index: 235;" id="cnotediv_'.$oid.'">'.$od->customer_note.'</div></td><td nowrap>'.$cust_sent.'</td><td>'.$om['_billing_company'][0].'</td><td style="background-color: '.$clr_custchbx.';">'.$om['_billing_last_name'][0].', '.$om['_billing_first_name'][0].'</td><td style="width: 20px; text-align: center;"><input type="checkbox" name="customer2send[]" title="Send customer to QB" value="'.$oid.'" '.$dsbl_custchbx.' '.$chk_custchbx.' /></td><td>'.$om['_billing_email'][0].'</td><td style="color: '.$phstyle.';" nowrap>'.$phonum.'</td><td>'.$om['_billing_first_name'][0].' '.$om['_billing_last_name'][0].' '.$om['_billing_address_1'][0].' '.$om['_billing_city'][0].' '.$om['_billing_state'][0].' '.$om['_billing_postcode'][0].'</td><td>'.$shipdiff.'</td><td style="text-align: right;">'.$om['_order_total'][0].'</td><td style="width: 20px; text-align: center;">'.$chtbx.'</td><td style="width: 130px; text-align: center; background-color: '.$clr_paychbx.';">'.$pmt.'</td><td style="width: 20px; text-align: center;"><input type="checkbox" name="clschb_'.$oid.'" value="'.$oid.'" OnChange="runtcls(this);" '.$tclschecked.' '.$dsbl_0.' /></td>'; 	$trows .= '</tr>';	}$recoptlist = array(	'<option value="50">50</option>',	'<option value="100">100</option>',	'<option value="500">500</option>',	'<option value="1000">1000</option>',	'<option value="10000">All</option>'	);$pcnt = '<div style="float: left;"><form action="#" method="post" name="pgref" style="margin: 0px;"><input type="button" name="brfrsh" value="Refresh" OnClick="this.form.submit();" style="width: 70px; margin: 0px 9px;" />Records - <select name="rowsonpage" id="rowsonpage" OnChange="this.form.submit();">'.getopts($recoptlist, $_POST['rowsonpage']).'</select>&nbsp;&nbsp;&nbsp;<div style="float: right; width: 500px; height: 20px; margin-left: 100px;"><div style="float: left; width: 120px; height: 20px; margin-right: 20px;"><div style="float: left; width: 20px; height: 20px; background: #eee;"></div> - Not sent yet</div><div style="float: left; width: 120px; height: 20px; margin-right: 20px;"><div style="float: left; width: 20px; height: 20px; background: #fc0;"></div> - Estimate sent</div><div style="float: left; width: 120px; height: 20px;"><div style="float: left; width: 20px; height: 20px; background: #0cf;"></div> - Sent to QB</div></div><div style="float: right;"><input type="text" name="SWord" value="'.$_POST['SWord'].'" /><input type="submit" name="srchsbm" value="Search" /></div></form></div><form action="#" method="post" name="qform" style="margin-top: 20px;"><input type="hidden" name="fsbm" value="1" /><!-- select name="itemsel">	<option value="0">With selected</option>	<option value="1">Send Customer(s)</option>	<option value="2" disabled>Send Order(s)</option>	<option value="3" disabled>Send Payment(s)</option></select --><input type="submit" name="button" value="Send" style="float: right; width: 70px; margin: 0px 9px;" /><table class="TBL" width="100%" cellspacing="1"><tr><th></th>	<th style="font-size: 13px;" colspan="4">Transactions</th>	<th style="font-size: 13px;" colspan="8">Customers</th>	<th style="font-size: 13px;" colspan="3">Payments</th>	<th></th></tr><tr><th></th>	<th>Order ID</th>	<th><!-- input type="checkbox" name="chb1_0" value="1" dOnChange="chkallb(this);" Title="Check all" / --></th>	<th></th>	<th>Created (Date Time)</th>	<th>QB List ID</th>	<th>Company</th>	<th>Name</th>	<th><!-- input type="checkbox" name="chb2_0" value="1" dOnChange="chkallb(this);" Title="Check all" / --></th>	<th>EMail</th>	<th>Phone</th>	<th>Billing Address</th>	<th>Shipping Address</th>	<th>Total (USD)</th>	<th><!-- input type="checkbox" name="chb2_0" value="1" dOnChange="chkallb(this);" Title="Check all" / --></th>	<th>Paid (Date Time)</th>	<th>Done</th></tr>'.$trows.'<tr><th></th>	<th>Order ID</th>	<th></th>	<th></th>	<th>Created (Date Time)</th>	<th>QB List ID</th>	<th>Company</th>	<th>Name</th>	<th></th>	<th>EMail</th>	<th>Phone</th>	<th>Billing Address</th>	<th>Shipping Address</th>	<th>Total (USD)</th>	<th></th>	<th>Paid (Date Time)</th>	<th></th></tr></table></form><script>function pupnote(o){var id = o.id.replace(/cnotd_/, "cnotediv_");	document.getElementById(id).style.display = "block";	return;	}function pclsnote(o){var id = o.id.replace(/cnotd_/, "cnotediv_");	document.getElementById(id).style.display = "none";	return;	}function bgtrput(o){//	document.getElementById(o.id).style.backgroundColor = "rgba(255, 255, 255, 0.7)";	o.style.backgroundColor = "rgba(255, 255, 255, 0.7)";	o.style.boxShadow = "5px 5px 5px #555";	o.style.border = "solid 1px #555";	return;}function bgtrrmv(o){//	alert(o.id);//	document.getElementById(o.id).style.backgroundColor = "rgba(255, 255, 255, 1)";	o.style.backgroundColor = "rgba(255, 255, 255, 1)";	o.style.boxShadow = "10px 15px 15px #555";	o.style.border = "solid 1px #000";	return;}function slcustomer(o){if(o.value.length >= 3){var oid = o.id.replace("ptxbx_", "");var url = "dispcns.php?sbj=pmt&oid="+oid;	load_console(url, \'40%\', \'90%\');	}	return false;}function load_console(url, wd, ht){ //alert(url); return false;var	obj = document.getElementById("CConsole");var	pln = document.getElementById("consolink");	pln.href = url+"&cns=pf";	obj.style.display = "block";	obj.style.width = wd;	obj.style.height = ht;	query_srv(url, \'InConsole\');	return false;}function ClsConsole(){	document.getElementById("CConsole").style.display = "none";	return;}function srchc_______(o){	if(o.value.length<3){return false;}	var d = document.getElementById("cstsrchresults");		d.style.display = "block";			var url = "srchqbcustomer.php?n="+o.value;		query_srv( url, d );	return false;}function selsbx______(o){	document.getElementById("manualcustomerselect").value = o.name;	document.getElementById("cstsrchresults").style.display = "none";	return false;}var ornum;var tbk;function runtcls(o){var st;	if(o.checked) { st=1; }	else { st=0; }var url = "ajx_editcls.php?onum="+o.value+"&stt="+st;var res = perform(url);//alert(res); return;var dr = res.split(":::");var dtr = "dtr_"+dr[0];	var trobj = document.getElementById(dtr);if(dr[1]=="1") 	{ trobj.style.backgroundColor = "#090"; }else 		{ trobj.style.backgroundColor = "#ff9"; }	ornum = o.name.replace("clschb_", "");//alert(ornum);var o2o = document.getElementById("o2s_"+ornum);var p2o = document.getElementById("p2s_"+ornum);if(dr[1]=="1") 	{ o2o.disabled = true; p2o.disabled = true; }else			{ o2o.disabled = false; p2o.disabled = false; }}</script>';// $statuses = array_map( 'esc_sql', wc_get_is_paid_statuses() );// $cemails = $wpdb->get_col("   // SELECT DISTINCT pm.meta_value FROM {$wpdb->posts} AS p   // INNER JOIN {$wpdb->postmeta} AS pm ON p.ID = pm.post_id   // INNER JOIN {$wpdb->prefix}woocommerce_order_items AS i ON p.ID = i.order_id   // INNER JOIN {$wpdb->prefix}woocommerce_order_itemmeta AS im ON i.order_item_id = im.order_item_id   // WHERE p.post_status IN ( 'wc-" . implode( "','wc-", $statuses ) . "' )   // AND pm.meta_key IN ( '_billing_email' )   // AND im.meta_key IN ( '_product_id', '_variation_id' )   // AND im.meta_value = $product_id// ");//print_r( $cemails );//$users = get_users( array( 'fields' => array( 'ID','display_name','user_email' ) ) );/*foreach ($oo as $ok=>$ov){	$trows .= '<td><label style="color: #696;">'.$ok.'</lable></td><td><b>'.$oo[$ok][0].'</b></td>';	}	*//*_billing_company	_billing_first_name_billing_last_name_billing_phone_billing_email	_billing_address_1_billing_city_billing_state_billing_postcode_billing_country_shipping_company_shipping_first_name_shipping_last_name_shipping_address_1_shipping_city_shipping_state_shipping_postcode_shipping_country_billing_address_index_shipping_address_index_order_total_payment_method_paid_date*///print_r( $customer_emails );//foreach ($customer as $bk=>$bv){	//$trows .= '<tr><td>'.++$t.'. </td>';//foreach ($bv as $ck=>$cv){//$trows .= '<td>'.$bv.'</td>';//}//$trows .= '</tr>';	//}//$crows = $wpdb->get_results($wpdb->prepare("SELECT meta_value FROM $wpdb->postmeta WHERE meta_key = '_customer_user' AND meta_value > 0"), true);/*$customer_ids = $wpdb->get_col("SELECT DISTINCT meta_value  FROM $wpdb->postmeta    WHERE meta_key = '_customer_user' AND meta_value > 0");print_pr($customer_ids);$currency = ' (' . get_option('woocommerce_currency') . ')';if (sizeof($customer_ids) > 0){    foreach ($customer_ids as $customer_id){        $customer = new WP_User($customer_id);        $trows .= '<tr>            <td><?php echo $customer->display_name; ?></td>            <td><?php echo $customer->user_email; ?></td>            <td><?php echo wc_get_customer_total_spent($customer_id); ?></td>            <td><?php echo wc_get_customer_order_count($customer_id); ?></td>        </tr>		        <tr>            <th data-sort="string"><?php _e("Name", "woocommerce"); ?></th>            <th data-sort="string"><?php _e("Email", "woocommerce"); ?></th>            <th data-sort="float"><?php _e("Total spent", "woocommerce"); echo $currency; ?></th>            <th data-sort="int"><?php _e("Orders placed", "woocommerce"); ?></th>        </tr>				';	}}*/$pgtitle = '<h4>Customer list</h4>';$hsct = 'qbw';$pgcontent = <<<EOD__<!-- Page content start -->$pcnt<!-- Page content end -->EOD__;//	}	require_once('inc/_shell.php'); /////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////?>