<?phpini_set("display_errors", 1);ini_set('display_startup_errors',1);error_reporting(E_ALL);include_once('inc/_init.php');include_once('inc/functions/general.php');$pgcontent = NULL;if(isset($_POST['pass_reset_start'])){		$gres = prst_start();//	if($gres=='NF'){ echo 'User ID or Email not found'; exit; }		$pgcontent = ($gres)?'<div style="text-align: center; margin-top: 20px; color: #000; font-size: 13px;">Information to reset your credentials has been sent to your email.</div><div style="text-align: center; margin-top: 10px; color: #090; font-size: 17px;">Please check your email and complete the process.</div>':'<div style="text-align: center; padding: 20px; color: #f00; font-size: 17px;">Sending failed.</div>';	}elseif(isset($_GET['th'])){	$dlh = sha1($_GET['th'], FALSE);	if($dlh){		$rquery  = "SELECT * FROM qb_user WHERE TmpH='$dlh'"; 		$result  = mysqli_query($dbv, $rquery) or die (mysqli_error($dbv));		if($result){ $row = mysqli_fetch_array($result);			if($row['Id']){				$pgcontent = '<form name="PassRST01" method="post" action="account.php" OnSubmit="return formchck(this);"><div style="text-align: center; padding: 20px;"><input type="hidden" name="tmph" value="'.$_GET['th'].'"><input type="password" name="npass0" value="" style="width: 150px; margin: 2px; padding: 2px;" placeholder="Enter Password" /><br><input type="password" name="npass" value="" style="width: 150px; margin: 2px; padding: 2px;" placeholder="Confirm Password" /><br><div style="color: #f00;"><b>Note:</b> Password must be at least 8 characters of length</div><div style="color: #fc0;"><b>It is highly recommended to include uppercase letters, numbers and special symbols in the password</b></div><br><br><input type="submit" name="reset_pass" value="Reset Password" style="padding: 2px 5px;" /></div></form><script>function formchck(o){	if(!o.tmph.value){ alert("ERROR: Process failed"); return false; }	if(!o.npass0.value){ alert("Password not entered"); return false; }	if(o.npass.value != o.npass0.value){ alert("Password do not match"); return false; }	if(o.npass.value.length<8){ alert("Password is too short"); return false; }	return true;}</script>';				}			else{ 				$pgcontent = '<div style="text-align: center; padding: 20px; font-size: 17px; color: #f00;">Record Not found or Session Expired</div>';				}			}		}	}elseif(isset($_POST['reset_pass'])){		$dlh = (strlen($_POST['npass'])>=8 AND $_POST['npass0']==$_POST['npass'])?sha1($_POST['tmph'], FALSE):NULL;//	$dlh = sha1($_POST['tmph'], FALSE);		if($dlh){		$rquery  = "SELECT * FROM qb_user WHERE TmpH='$dlh'"; 		$result  = mysqli_query($dbv, $rquery) or die (mysql_error());		if($result){ //$row = mysqli_fetch_array($result);			$passhsh = sha1($_POST['npass'] . SWORD, FALSE);			$Sid = session_id();			get_session();			$bquery = "UPDATE qb_user SET Pass='$passhsh', SessH='$Sid', TmpH='7bd0utcefc400cc2d3d8c2ca3c30d63de494' WHERE TmpH='$dlh'";			mysqli_query($dbv, $bquery) or die (mysql_error());			$pgcontent = '<div style="text-align: center; padding: 20px; color: #090; font-size: 13px;">Password has been updated<br>Go to<a href="qbw.php">WC Terminal</a></div>';			}		else{ $pgcontent = 'Password update failed'; }		}	else{ $pgcontent = 'Password do not match'; }	}else{	if($lghsh['Id']){		$pgtitle = '<h4>Home</h4>';		$pgcontent = '	<link href="files/css/Page.css" type="text/css" rel="stylesheet" />	<!-- Page content start -->	<h4>Homepage</h4>	<!-- $lghsh[Id] -->	<!-- Page content end -->	';		}	else{		$pgcontent = '	<form name="PassRST00" method="post" action="#">	<div style="text-align: center; padding: 20px;">	<input type="text" name="user_id" value="" style="width: 250px; padding: 2px;" placeholder="Enter your user ID or Email" />	<input type="submit" name="pass_reset_start" value="Continue" style="padding: 2px 5px;" />	</div>	</form>	';		}	}$page_title       = 'Unified Management System - Home';$page_description = '';$keywords         = '';$head_ext         = '';	require_once('inc/_shell.php'); ////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////function prst_start(){ global $dbv;$th = sha1(mt_rand().time(), FALSE);$dh = sha1($th, FALSE);$row = array();$rquery  = "SELECT * FROM qb_user WHERE Login='$_POST[user_id]' OR  EMail='$_POST[user_id]'"; //$result  = mysqli_query($dbv, $rquery) or die (mysql_error());$result  = mysqli_query($dbv, $rquery);if($result){ $row = mysqli_fetch_array($result); 	if($row['Id']){		$bquery = "UPDATE qb_user SET TmpH='$dh' WHERE Id='$row[Id]'";		mysqli_query($dbv, $bquery);//			if(!mysqli_affected_rows($dbv)){ return 'NF'; }// echo '<a href="http://waverlycabinets.com/qbw/account.php?th='.$th.'">'.$row['Name'].' Update password</a>';		$subj = 'Reset Waverly Terminal Credentials';		$mssg = '<html><head><title>HTML email</title></head><body><div style="background: #ff9; padding: 20px;">Dear '.$row['Name'].',<br>This email has been sent to you because someone attempts to reset your Waverly Terminal account password<br>If it was not you just ignore this message and contact your system administrator.<br><br>Otherwise click the link  "<a href="http://waverlycabinets.com/qbw/account.php?th='.$th.'">Update Password</a>"please, to complete the process.</div></body></html>';//			$headers = "MIME-Version: 1.0" . "\r\n";//			$headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";			$header  = "From:info@waverlycabinets.com \r\n";			$header .= "MIME-Version: 1.0\r\n";			$header .= "Content-type: text/html\r\n";		return mail($row['EMail'],$subj,$mssg,$header);		}	}return NULL;}?>